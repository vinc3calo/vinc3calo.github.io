<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ESP Student Firmware Flasher</title>
<script type="module">
import "https://unpkg.com/esp-web-tools@9.3.0/dist/web/install-button.js";

document.addEventListener("DOMContentLoaded", () => {
  const modelSelect = document.getElementById("model");
  const groupSelect = document.getElementById("group");
  const container = document.getElementById("install-container");
  const statusBox = document.getElementById("status");

  // Map model + group to firmware file
  const firmwareMap = {
    "ESP8266": {
      "1": "firmware/ESP8266-group1.bin",
      "2": "firmware/ESP8266-group2.bin",
      "3": "firmware/ESP8266-group3.bin",
      "4": "firmware/ESP8266-group4.bin",
      "5": "firmware/ESP8266-group5.bin"
    },
    "ESP32": {
      "1": "firmware/ESP32-group1.bin",
      "2": "firmware/ESP32-group2.bin",
      "3": "firmware/ESP32-group3.bin",
      "4": "firmware/ESP32-group4.bin",
      "5": "firmware/ESP32-group5.bin"
    },
    "ESP32S2": {
      "1": "firmware/ESP32S2-group1.bin",
      "2": "firmware/ESP32S2-group2.bin",
      "3": "firmware/ESP32S2-group3.bin",
      "4": "firmware/ESP32S2-group4.bin",
      "5": "firmware/ESP32S2-group5.bin"
    },
    "ESP32S3": {
      "1": "firmware/ESP32S3-group1.bin",
      "2": "firmware/ESP32S3-group2.bin",
      "3": "firmware/ESP32S3-group3.bin",
      "4": "firmware/ESP32S3-group4.bin",
      "5": "firmware/ESP32S3-group5.bin"
    },
    "ESP32C3": {
      "1": "firmware/ESP32C3-group1.bin",
      "2": "firmware/ESP32C3-group2.bin",
      "3": "firmware/ESP32C3-group3.bin",
      "4": "firmware/ESP32C3-group4.bin",
      "5": "firmware/ESP32C3-group5.bin"
    }
  };

  function createInstaller() {
    const model = modelSelect.value;
    const group = groupSelect.value;
    container.innerHTML = "";

    if (!model) {
      statusBox.textContent = "Please select a device model.";
      return;
    }
    if (!group) {
      statusBox.textContent = "Please select a group.";
      return;
    }

    const firmwareUrl = firmwareMap[model][group];
    if (!firmwareUrl) {
      statusBox.textContent = "Firmware not found for this selection.";
      return;
    }

    statusBox.textContent = `Ready to flash: ${firmwareUrl}`;

    // Create installer button
    const installer = document.createElement("esp-web-install-button");
    installer.manifest = URL.createObjectURL(
      new Blob([JSON.stringify({
        name: `${model.toUpperCase()} Group ${group} Firmware`,
        version: "1.0.0",
        builds: [
          {
            chipFamily: model.toUpperCase(),
            parts: [{
              path: firmwareUrl,
              offset: model.toLowerCase() === "esp8266" ? 0 : 4096
            }]
          }
        ]
      })], { type: "application/json" })
    );
    installer.className = "installer";

    installer.addEventListener("update", (e) => {
      if (e.detail && e.detail.state) {
        statusBox.textContent = `Status: ${e.detail.state}`;
      }
    });

    container.appendChild(installer);
  }

  modelSelect.addEventListener("change", createInstaller);
  groupSelect.addEventListener("change", createInstaller);
});
</script>

<style>
body { font-family: system-ui, sans-serif; background:#f7f9fc; text-align:center; padding:50px; }
h1 { color:#333; }
select { font-size:1rem; padding:0.5em 1em; margin:0.5em; border-radius:8px; border:1px solid #ccc; }
#install-container { margin-top:20px; }
esp-web-install-button::part(button) {
  background-color:#0078d7; color:white; border:none; border-radius:8px; padding:0.7em 1.2em; cursor:pointer; font-size:1rem;
}
esp-web-install-button::part(button):hover { background-color:#005fa3; }
#status { margin-top:20px; color:#333; font-weight:500; }
footer { margin-top:30px; color:#666; font-size:0.9rem; }
</style>
</head>
<body>
<h1>ESP Student Firmware Flasher</h1>
<p>Select your ESP model and group, then click “Connect & Install.”</p>

<select id="model">
  <option value="">-- Select Model --</option>
  <option value="ESP8266">ESP8266</option>
  <option value="ESP32">ESP32</option>
  <option value="ESP32S2">ESP32-S2</option>
  <option value="ESP32S3">ESP32-S3</option>
  <option value="ESP32C3">ESP32-C3</option>
</select>

<select id="group">
  <option value="">-- Select Group --</option>
  <option value="1">Group 1</option>
  <option value="2">Group 2</option>
  <option value="3">Group 3</option>
  <option value="4">Group 4</option>
  <option value="5">Group 5</option>
</select>

<div id="install-container"></div>
<div id="status">Waiting for selection...</div>

<footer>Works in Chrome or Edge (desktop). Ensure your ESP is connected via USB.</footer>
</body>
</html>
