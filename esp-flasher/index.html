<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ESP Student Firmware Flasher</title>
<script type="module">
import "https://unpkg.com/esp-web-tools@9.3.0/dist/web/install-button.js";

document.addEventListener("DOMContentLoaded", () => {
  const modelSelect = document.getElementById("model");
  const groupSelect = document.getElementById("group");
  const container = document.getElementById("install-container");
  const statusBox = document.getElementById("status");

  // Only include the binaries you actually have
  const firmwareMap = {
    "ESP8266": {
      "1": "./firmware/ESP8266-group1.bin",
      "2": "./firmware/ESP8266-group2.bin"
    }
    // Add more models/groups when you have binaries
  };

  function createInstaller() {
    const model = modelSelect.value;
    const group = groupSelect.value;
    container.innerHTML = "";

    if (!model) {
      statusBox.textContent = "Please select a device model.";
      return;
    }
    if (!group) {
      statusBox.textContent = "Please select a group.";
      return;
    }

    const firmwareUrl = firmwareMap[model]?.[group];
    if (!firmwareUrl) {
      statusBox.textContent = `Firmware not available for ${model} group ${group}`;
      console.error("Firmware URL missing:", model, group);
      return;
    }

    statusBox.textContent = `Ready to flash: ${firmwareUrl}`;

    const manifestObj = {
      name: `${model.toUpperCase()} Group ${group} Firmware`,
      version: "1.0.0",
      builds: [
        {
          chipFamily: model.toUpperCase(),
          parts: [{
            path: firmwareUrl,   // firmwareUrl now uses ./firmware/...
            offset: model.toLowerCase() === "esp8266" ? 0 : 4096
          }]
        }
      ]
    };


    const blob = new Blob([JSON.stringify(manifestObj)], { type: "application/json" });

    const installer = document.createElement("esp-web-install-button");
    installer.manifest = URL.createObjectURL(blob);
    installer.className = "installer";

    installer.addEventListener("update", (e) => {
      if (e.detail && e.detail.state) {
        statusBox.textContent = `Status: ${e.detail.state} | Device: ${model.toUpperCase()}-${group.padStart(3,"0")}`;
      }
    });

    container.appendChild(installer);
  }

  modelSelect.addEventListener("change", createInstaller);
  groupSelect.addEventListener("change", createInstaller);
});
</script>

<style>
body { font-family: system-ui, sans-serif; background:#f7f9fc; text-align:center; padding:50px; }
h1 { color:#333; }
select { font-size:1rem; padding:0.5em 1em; margin:0.5em; border-radius:8px; border:1px solid #ccc; }
#install-container { margin-top:20px; }
esp-web-install-button::part(button) {
  background-color:#0078d7; color:white; border:none; border-radius:8px; padding:0.7em 1.2em; cursor:pointer; font-size:1rem;
}
esp-web-install-button::part(button):hover { background-color:#005fa3; }
#status { margin-top:20px; color:#333; font-weight:500; }
footer { margin-top:30px; color:#666; font-size:0.9rem; }
</style>
</head>
<body>
<h1>ESP Student Firmware Flasher</h1>
<p>Select your ESP model and group, then click “Connect & Install.”</p>

<select id="model">
  <option value="">-- Select Model --</option>
  <option value="ESP8266">ESP8266</option>
</select>

<select id="group">
  <option value="">-- Select Group --</option>
  <option value="1">Group 1</option>
  <option value="2">Group 2</option>
</select>

<div id="install-container"></div>
<div id="status">Waiting for selection...</div>

<footer>Works in Chrome or Edge (desktop). Ensure your ESP is connected via USB.</footer>
</body>
</html>
